#include <msp430.h>
#include "dr_adc.h"
#include "clock.h"
const unsigned int sin_wave[]={2047,2048,2050,2051,2053,2054,2056,2057,2059,2061,2062,2064,2065,2067,2068,2070,2071,2073,2075,2076,2078,2079,2081,2082,2084,2085,2087,2089,2090,2092,2093,2095,2096,2098,2099,2101,2102,2104,2105,2107,2108,2110,2111,2113,2115,2116,2118,2119,2121,2122,2124,2125,2126,2128,2129,2131,2132,2134,2135,2137,2138,2140,2141,2143,2144,2146,2147,2148,2150,2151,2153,2154,2156,2157,2158,2160,2161,2163,2164,2165,2167,2168,2169,2171,2172,2174,2175,2176,2178,2179,2180,2182,2183,2184,2186,2187,2188,2189,2191,2192,2193,2195,2196,2197,2198,2200,2201,2202,2203,2205,2206,2207,2208,2209,2211,2212,2213,2214,2215,2217,2218,2219,2220,2221,2222,2223,2225,2226,2227,2228,2229,2230,2231,2232,2233,2234,2235,2236,2238,2239,2240,2241,2242,2243,2244,2245,2246,2247,2248,2248,2249,2250,2251,2252,2253,2254,2255,2256,2257,2258,2259,2259,2260,2261,2262,2263,2264,2264,2265,2266,2267,2268,2268,2269,2270,2271,2271,2272,2273,2274,2274,2275,2276,2276,2277,2278,2278,2279,2280,2280,2281,2281,2282,2283,2283,2284,2284,2285,2286,2286,2287,2287,2288,2288,2289,2289,2290,2290,2291,2291,2291,2292,2292,2293,2293,2293,2294,2294,2295,2295,2295,2296,2296,2296,2297,2297,2297,2297,2298,2298,2298,2299,2299,2299,2299,2299,2300,2300,2300,2300,2300,2300,2301,2301,2301,2301,2301,2301,2301,2301,2301,2301,2301,2301,2301,2301,2302,2301,2301,2301,2301,2301,2301,2301,2301,2301,2301,2301,2301,2301,2301,2300,2300,2300,2300,2300,2300,2299,2299,2299,2299,2299,2298,2298,2298,2297,2297,2297,2297,2296,2296,2296,2295,2295,2295,2294,2294,2293,2293,2293,2292,2292,2291,2291,2291,2290,2290,2289,2289,2288,2288,2287,2287,2286,2286,2285,2284,2284,2283,2283,2282,2281,2281,2280,2280,2279,2278,2278,2277,2276,2276,2275,2274,2274,2273,2272,2271,2271,2270,2269,2268,2268,2267,2266,2265,2264,2264,2263,2262,2261,2260,2259,2259,2258,2257,2256,2255,2254,2253,2252,2251,2250,2249,2248,2248,2247,2246,2245,2244,2243,2242,2241,2240,2239,2238,2236,2235,2234,2233,2232,2231,2230,2229,2228,2227,2226,2225,2223,2222,2221,2220,2219,2218,2217,2215,2214,2213,2212,2211,2209,2208,2207,2206,2205,2203,2202,2201,2200,2198,2197,2196,2195,2193,2192,2191,2189,2188,2187,2186,2184,2183,2182,2180,2179,2178,2176,2175,2174,2172,2171,2169,2168,2167,2165,2164,2163,2161,2160,2158,2157,2156,2154,2153,2151,2150,2148,2147,2146,2144,2143,2141,2140,2138,2137,2135,2134,2132,2131,2129,2128,2126,2125,2124,2122,2121,2119,2118,2116,2115,2113,2111,2110,2108,2107,2105,2104,2102,2101,2099,2098,2096,2095,2093,2092,2090,2089,2087,2085,2084,2082,2081,2079,2078,2076,2075,2073,2071,2070,2068,2067,2065,2064,2062,2061,2059,2057,2056,2054,2053,2051,2050,2048,2047,2045,2043,2042,2040,2039,2037,2036,2034,2032,2031,2029,2028,2026,2025,2023,2022,2020,2018,2017,2015,2014,2012,2011,2009,2008,2006,2004,2003,2001,2000,1998,1997,1995,1994,1992,1991,1989,1988,1986,1985,1983,1982,1980,1978,1977,1975,1974,1972,1971,1969,1968,1967,1965,1964,1962,1961,1959,1958,1956,1955,1953,1952,1950,1949,1947,1946,1945,1943,1942,1940,1939,1937,1936,1935,1933,1932,1930,1929,1928,1926,1925,1924,1922,1921,1919,1918,1917,1915,1914,1913,1911,1910,1909,1907,1906,1905,1904,1902,1901,1900,1898,1897,1896,1895,1893,1892,1891,1890,1888,1887,1886,1885,1884,1882,1881,1880,1879,1878,1876,1875,1874,1873,1872,1871,1870,1868,1867,1866,1865,1864,1863,1862,1861,1860,1859,1858,1857,1855,1854,1853,1852,1851,1850,1849,1848,1847,1846,1845,1845,1844,1843,1842,1841,1840,1839,1838,1837,1836,1835,1834,1834,1833,1832,1831,1830,1829,1829,1828,1827,1826,1825,1825,1824,1823,1822,1822,1821,1820,1819,1819,1818,1817,1817,1816,1815,1815,1814,1813,1813,1812,1812,1811,1810,1810,1809,1809,1808,1807,1807,1806,1806,1805,1805,1804,1804,1803,1803,1802,1802,1802,1801,1801,1800,1800,1800,1799,1799,1798,1798,1798,1797,1797,1797,1796,1796,1796,1796,1795,1795,1795,1794,1794,1794,1794,1794,1793,1793,1793,1793,1793,1793,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1792,1793,1793,1793,1793,1793,1793,1794,1794,1794,1794,1794,1795,1795,1795,1796,1796,1796,1796,1797,1797,1797,1798,1798,1798,1799,1799,1800,1800,1800,1801,1801,1802,1802,1802,1803,1803,1804,1804,1805,1805,1806,1806,1807,1807,1808,1809,1809,1810,1810,1811,1812,1812,1813,1813,1814,1815,1815,1816,1817,1817,1818,1819,1819,1820,1821,1822,1822,1823,1824,1825,1825,1826,1827,1828,1829,1829,1830,1831,1832,1833,1834,1834,1835,1836,1837,1838,1839,1840,1841,1842,1843,1844,1845,1845,1846,1847,1848,1849,1850,1851,1852,1853,1854,1855,1857,1858,1859,1860,1861,1862,1863,1864,1865,1866,1867,1868,1870,1871,1872,1873,1874,1875,1876,1878,1879,1880,1881,1882,1884,1885,1886,1887,1888,1890,1891,1892,1893,1895,1896,1897,1898,1900,1901,1902,1904,1905,1906,1907,1909,1910,1911,1913,1914,1915,1917,1918,1919,1921,1922,1924,1925,1926,1928,1929,1930,1932,1933,1935,1936,1937,1939,1940,1942,1943,1945,1946,1947,1949,1950,1952,1953,1955,1956,1958,1959,1961,1962,1964,1965,1967,1968,1969,1971,1972,1974,1975,1977,1978,1980,1982,1983,1985,1986,1988,1989,1991,1992,1994,1995,1997,1998,2000,2001,2003,2004,2006,2008,2009,2011,2012,2014,2015,2017,2018,2020,2022,2023,2025,2026,2028,2029,2031,2032,2034,2036,2037,2039,2040,2042,2043,2045};
void initADC()
{
  //内存变量初始化
  //IO设定
  P7SEL |= BIT7; //保证没有输出干扰模拟信号输入
  //TB0设定，用于ADC触发脉冲
//  TB0CTL = TBSSEL__SMCLK + MC__UP; // SMCLK, up-mode
//  TB0CCR0 = 4000000 / 6400 - 1; // 4MHz -> 6.4kHz
//  TB0CCTL0 = OUTMOD_4; //实际只有3.2kHz
  //ADC设定
  ADC12CTL1 = ADC12SHS_2 + ADC12SHP + ADC12CONSEQ_1; //TB0.0，脉冲采样，多通道单次
  ADC12MCTL0 = ADC12SREF_0 + ADC12INCH_15 + ADC12EOS; //3.3V电源参考，A15，通道末尾
  ADC12CTL0 = ADC12MSC + ADC12ON + ADC12SHT0_8 + ADC12ENC; //多重采样，ADC12ON，MEM0~MEM7使用256周期采样，ENC
  ADC12IE = BIT0; //开启中断(通道0转换完成后中断)
}
void initDAC()
{
   P7DIR |= BIT6;//设置P7.6口为输出口
	 P7SEL |= BIT6;//使能P7.6口第二功能位
	 DAC12_0CTL0 |= DAC12IR; //设置参考电压满刻度值，使Vout = Vref×(DAC12_xDAT/4096)
	 DAC12_0CTL0 |= DAC12SREF_1; //设置参考电压为AVCC
	 DAC12_0CTL0 |= DAC12AMP_5;	//设置运算放大器输入输出缓冲器为中速中电流
	 DAC12_0CTL0 |= DAC12CALON; //启动校验功能
	 DAC12_0CTL0 |= DAC12OPS;//选择第二通道P7.6
	 DAC12_0CTL0 |= DAC12ENC; //转化使能
	 DAC12_0DAT = 0xFFF; //输入数据
}

#define uchar unsigned char
uchar m,n,TR0; 
const uchar  T[49][2]={{0,0},
{0xF8,0x8B},{0xF8,0xF2},{0xF9,0x5B},{0xF9,0xB7},{0xFA,0x14},{0xFA,0x66},{0xFA,0xB9},{0xFB,0x03},{0xFB,0x4A},{0xFB,0x8F},{0xFB,0xCF},{0xFC,0x0B},
{0xFC,0x43},{0xFC,0x78},{0xFC,0xAB},{0xFC,0xDB},{0xFD,0x08},{0xFD,0x33},{0xFD,0x5B},{0xFD,0x81},{0xFD,0xA5},{0xFD,0xC7},{0xFD,0xE7},{0xFE,0x05},
{0xFE,0x21},{0xFE,0x3C},{0xFE,0x55},{0xFE,0x6D},{0xFE,0x84},{0xFE,0x99},{0xFE,0xAD},{0xFE,0xC0},{0xFE,0x02},{0xFE,0xE3},{0xFE,0xF3},{0xFF,0x02},
{0xFF,0x10},{0xFF,0x1D},{0xFF,0x2A},{0xFF,0x36},{0xFF,0x42},{0xFF,0x4C},{0xFF,0x56},{0xFF,0x60},{0xFF,0x69},{0xFF,0x71},{0xFF,0x79},{0xFF,0x81}
};
const uchar music[][2]={{0,4},
{22,8},{29,6},{32,2},{29,4},{22,4},{25,8},{22,2},{25,2},{22,2},{25,2},{29,8},{29,2},{27,2},{29,2},{25,2},{22,8},
{29,6},{32,2},{34,4},{34,4},{34,4},{29,4},{32,8},
//μú?tDD	
{29,2},{32,2},{29,2},{32,2},{34,4},{34,4},{34,4},{29,4},{32,8},	 
{32,4},{22,4},{32,4},{22,4},{29,4},{29,4},{25,8}, 
{27,8},{27,8},{27,4},{25,2},{27,2},{29,4},{32,4},	   	
//μúèyDD?-°?
{34,8},{41,8},{29,8},{41,8},{29,4},{41,4},{29,4},{41,4},
{29,8},{41,8},{0,2},{27,8},{27,8},{27,4},{25,2},{27,2},{29,4},{32,4},{34,12},
{0xFF,0xFF}};

void delay(uchar p)
{
//    uchar i,j; 
//    for(;p>0;p--)
//    for(i=181;i>0;i--)
//    for(j=181;j>0;j--);
  delay_ms(p*50);
}

void pause()
{
//    uchar i,j;
//    for(i=150;i>0;i--)
//    for(j=150;j>0;j--);
  delay_ms(80);
}
uint16_t timer_cnt=0;
void T0_int()
{
  static char i=1;
  if(TR0){
    if(timer_cnt<=0){
      timer_cnt=(49-m)/2;
      if(i){
        DAC12_0DAT = 0x7f;i=0;}
      else{
        DAC12_0DAT = 0x00;i=1;}  
    }
    timer_cnt--;
  }
  else
    DAC12_0DAT = 0x00;
}

void audio()
{
 static uchar i=0; 
 while(1) 
      {
         m=music[i][0];n=music[i][1]; 
         
         if(m==0x00)
           {TR0=0;delay(n);i++;} 
         else if(m==0xFF)
           {TR0=0;delay(30);i=0;break;} 
//         else if(m==music[i+1][0]) 
//           {TR0=1;delay(n);TR0=0;pause();i++;}
         else
           {TR0=1;delay(n);i++;}
      }
}
